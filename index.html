<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Lyrics Annotator</title>
	<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
	<style>
		:root { --primary: #0081ff; }
		.tag-pill { cursor: pointer; margin-right: 4px; margin-bottom: 4px; font-size: 0.75rem; display: inline-block; padding: 2px 8px; border-radius: 12px; border: 1px solid #ccc; }
		.active-tag { background-color: var(--primary); color: white; border-color: var(--primary); }
		.lyrics-box { white-space: pre-wrap; font-family: 'Courier New', monospace; background: #fdfdfd; padding: 15px; border: 1px solid #eee; border-radius: 8px; font-size: 0.9rem; }
		.annotation-block { border-left: 4px solid var(--primary); padding-left: 10px; margin-bottom: 15px; background: #f9f9f9; }
		.sub-text { font-size: 0.8rem; color: #666; }
		summary { font-weight: bold; }
		.nav-links { margin-bottom: 20px; }
		.tag-group { margin-bottom: 1rem; }
	</style>
</head>
<body>
	<main class="container" id="app">
		<header>
			<nav>
				<ul><li><strong>LyricDB</strong></li></ul>
				<ul>
					<li><a href="#" @click="view = 'songs'">Songs</a></li>
					<li><a href="#" @click="view = 'tags'">Tags</a></li>
				</ul>
			</nav>
		</header>

		<div v-if="loading" aria-busy="true">Loading song data...</div>

		<div v-else>
			
			<section v-if="view === 'tags' || view === 'songs'">
				<details open>
					<summary>Filter by Tags ({{selectedTags.length}} active)</summary>
					<div v-for="(subtags, category) in hierarchicalTags" :key="category" class="tag-group">
						<small><strong>{{ category.toUpperCase() }}</strong></small><br>
						<span v-for="tag in subtags" 
							:key="tag" 
							class="tag-pill" 
							:class="{'active-tag': selectedTags.includes(tag)}"
							@click="toggleTag(tag)">
							{{ tag.includes('.') ? tag.split('.')[1] : tag }}
						</span>
					</div>
					<button v-if="selectedTags.length" class="outline secondary" @click="selectedTags = []">Clear Filters</button>
				</details>

				<hr>

				<div v-if="view === 'songs'">
					<h3>Songs matching filters ({{ filteredSongs.length }})</h3>
					<article v-for="song in filteredSongs" :key="song.title">
						<header>
							<a href="#" @click.prevent="openSong(song)"><strong>{{ song.title }}</strong></a>
							<div class="sub-text">{{ song.album }} ({{ song.year || 'N/A' }})</div>
						</header>
						<div class="tag-list">
							<span v-for="t in song.song_labels" class="tag-pill active-tag">{{t}}</span>
						</div>
					</article>
				</div>

				<div v-if="view === 'tags' && selectedTags.length > 0">
					<h3>Annotated Lyrics for selected tags</h3>
					<div v-for="item in filteredLyrics" class="annotation-block">
						<blockquote style="margin:0; border:none; padding:0;">
							"{{ item.text }}"
						</blockquote>
						<div class="sub-text">
							— <strong>{{ item.song }}</strong> ({{ item.tag }}) 
							<a href="#" @click.prevent="openSongByTitle(item.song)">View Song</a>
						</div>
					</div>
				</div>
			</section>

			<section v-if="view === 'song_detail' && currentSong">
				<button class="outline" @click="view = 'songs'">← Back</button>
				<h2>{{ currentSong.title }}</h2>
				<p>Album: {{ currentSong.album }} | Date: {{ currentSong.date || 'Unknown' }}</p>
				
				<div class="tag-list">
					<strong>Song Tags:</strong>
					<span v-for="t in currentSong.song_labels" class="tag-pill active-tag">{{t}}</span>
				</div>

				<div class="lyrics-box" v-if="rawLyrics">{{ rawLyrics }}</div>
				<div v-else aria-busy="true">Loading lyrics...</div>

				<hr>
				<h4>Annotations ({{ currentSong.annotations.length }})</h4>
				<div v-for="anno in currentSong.annotations" class="annotation-block">
					<small>Tag: <strong>{{ anno.label }}</strong> (Lines {{ anno.start }} - {{ anno.end }})</small>
					<p style="margin-top: 5px;"><em>"{{ anno.text }}"</em></p>
				</div>
			</section>

		</div>
	</main>

	<script>
		const { createApp } = Vue;

		createApp({
			data() {
				return {
					loading: true,
					view: 'songs',
					db: {},
					selectedTags: [],
					currentSong: null,
					rawLyrics: ''
				}
			},
			computed: {
				songs() {
					// Transform dictionary to array and inject title
					return Object.entries(this.db).map(([title, data]) => ({
						title,
						...data
					}));
				},
				hierarchicalTags() {
					const tree = {};
					this.songs.forEach(song => {
						const allTags = [...(song.song_labels || []), ...song.annotations.map(a => a.label)];
						allTags.forEach(t => {
							const category = t.includes('.') ? t.split('.')[0] : 'general';
							if (!tree[category]) tree[category] = new Set();
							tree[category].add(t);
						});
					});
					Object.keys(tree).forEach(k => tree[k] = Array.from(tree[k]).sort());
					return tree;
				},
				filteredSongs() {
					if (this.selectedTags.length === 0) return this.songs;
					return this.songs.filter(song => {
						const songTags = [...(song.song_labels || []), ...song.annotations.map(a => a.label)];
						// Requirement 5: Combinations (Match ALL selected tags)
						return this.selectedTags.every(t => songTags.includes(t));
					});
				},
				filteredLyrics() {
					const results = [];
					this.songs.forEach(song => {
						song.annotations.forEach(anno => {
							if (this.selectedTags.includes(anno.label)) {
								results.push({
									song: song.title,
									tag: anno.label,
									text: anno.text
								});
							}
						});
					});
					return results;
				}
			},
			methods: {
				toggleTag(tag) {
					const idx = this.selectedTags.indexOf(tag);
					if (idx > -1) this.selectedTags.splice(idx, 1);
					else this.selectedTags.push(tag);
				},
				openSong(song) {
					this.currentSong = song;
					this.view = 'song_detail';
					this.rawLyrics = '';
					fetch(song.lyrics_path)
						.then(r => r.text())
						.then(t => this.rawLyrics = t)
						.catch(() => this.rawLyrics = "Error: Lyrics file not found at " + song.lyrics_path);
				},
				openSongByTitle(title) {
					const song = this.songs.find(s => s.title === title);
					if (song) this.openSong(song);
				}
			},
			async mounted() {
				try {
					const response = await fetch('songs.json');
					this.db = await response.json();
					this.loading = false;
				} catch (e) {
					alert("Failed to load songs.json. Ensure it is in the same folder.");
				}
			}
		}).mount('#app');
	</script>
</body>
</html>