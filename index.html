<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Lyric Host</title>
	<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
	<script src="https://cdn.tailwindcss.com"></script>
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400&display=swap" rel="stylesheet">
	<style>
		body { font-family: 'Noto Sans', sans-serif; font-weight: 400 !important; }
		* { font-weight: 400 !important; font-style: normal !important; }
		.tag-pill { cursor: pointer; font-size: 0.7rem; padding: 2px 8px; border-radius: 9999px; border: 1px solid #e5e7eb; transition: all 0.2s; white-space: nowrap; display: inline-block; margin: 2px; }
		.active-tag { background-color: #0081ff; color: white; border-color: #0081ff; }
		.active-parent { color: #0081ff; text-decoration: none; }
		.lyrics-box { white-space: pre-wrap; background: #f9fafb; padding: 1rem; border-radius: 0.5rem; border: 1px solid #e5e7eb; font-size: 0.875rem; }
		.annotation-block { border-left: 3px solid #0081ff; padding-left: 0.75rem; margin-bottom: 1rem; }
	</style>
</head>
<body class="bg-white text-gray-900">
	<main class="max-w-4xl mx-auto p-4" id="app">
		<header class="flex flex-col gap-4 mb-6">
			<nav class="flex justify-between items-center border-b pb-4">
				<div class="text-lg">Lyric Host</div>
				<ul class="flex gap-4 list-none m-0 p-0">
					<li><a href="#" class="text-blue-600 no-underline" @click="view = 'tags'">Snippet View</a></li>
					<li><a href="#" class="text-blue-600 no-underline" @click="view = 'songs'">Songs</a></li>
				</ul>
			</nav>
			<input type="search" v-model="searchQuery" placeholder="Search song titles..." class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500">
		</header>

		<div v-if="loading" class="text-center py-10">Loading...</div>

		<div v-else>
			<section v-if="view !== 'song_detail'">
				<div class="mb-6">
					<div class="flex items-center gap-4 mb-2">
						<span class="text-sm">Filter ({{selectedTags.length + selectedCategories.length}} active)</span>
						<button v-if="selectedTags.length || selectedCategories.length" 
							@click="resetFilters" 
							class="text-xs text-red-500 border border-red-500 px-2 py-1 rounded hover:bg-red-50">
							Clear
						</button>
					</div>
					
					<div v-for="(subtags, cat) in hierarchicalTags" :key="cat" class="mb-4">
						<span class="text-xs text-gray-500 cursor-pointer hover:text-blue-500" 
							:class="{'active-parent': selectedCategories.includes(cat)}" 
							@click="toggleParent(cat)">
							{{ cat }}
						</span>
						<div class="flex flex-wrap gap-1 mt-1">
							<span v-for="tag in subtags" :key="tag" class="tag-pill" 
								:class="{'active-tag': selectedTags.includes(tag)}" @click="toggleTag(tag)">
								{{ tag.split('.')[1] || tag }}
								<span class="ml-1 opacity-70 text-[0.6rem]">{{ getTagCount(tag) }} / {{ totalTagCounts[tag] || 0 }}</span>
							</span>
						</div>
					</div>
				</div>

				<hr class="my-6 border-gray-200">

				<div v-if="view === 'songs'" class="flex flex-wrap gap-x-6 gap-y-4">
					<div v-for="song in filteredSongs" :key="song.id" class="border-r border-gray-200 pr-6 last:border-0">
						<a href="#" @click.prevent="openSong(song)" class="text-blue-600 no-underline">{{ song.id }}</a>
						<span class="text-xs text-gray-500 ml-2">({{ song.album }})</span>
						<div v-if="song.song_labels && song.song_labels.length" class="mt-1">
							<span v-for="t in song.song_labels" class="tag-pill active-tag">{{t}}</span>
						</div>
					</div>
				</div>

				<div v-if="view === 'tags'" class="space-y-6">
					<div v-for="item in filteredLyrics" class="annotation-block">
						<p class="text-xs m-0 leading-relaxed text-gray-700">"{{ item.text }}"</p>
						<div class="text-[0.7rem] text-gray-500 mt-1">
							<span class="text-blue-600 cursor-pointer hover:underline" @click="openSongByTitle(item.song)">{{ item.song }}</span> 
							<span class="ml-1">({{ item.tag }})</span>
						</div>
					</div>
				</div>
			</section>

			<section v-if="view === 'song_detail' && currentSong">
				<button @click="view = 'tags'" class="mb-4 text-xs border border-gray-300 px-3 py-1 rounded hover:bg-gray-50">‚Üê Back</button>
				<h2 class="text-xl mb-1">{{ currentSong.id }}</h2>
				<p class="text-xs text-gray-500 mb-6">Album: {{ currentSong.album }}</p>
				<div class="lyrics-box" v-html="rawLyrics || 'Loading lyrics...'"></div>
				<hr class="my-8 border-gray-200">
				<h4 class="text-sm mb-4">Annotations</h4>
				<div v-for="anno in currentSong.annotations" class="annotation-block">
					<div class="text-[0.7rem] text-gray-500 mb-1">{{ anno.label }}</div>
					<p class="text-xs">"{{ anno.text }}"</p>
				</div>
			</section>
		</div>
	</main>

	<script>
		const { createApp } = Vue;
		createApp({
			data() {
				return {
					loading: true, 
					view: 'tags', // System defaults to snippet view
					db: {}, 
					selectedTags: [], 
					selectedCategories: [], 
					searchQuery: '',
					currentSong: null, 
					rawLyrics: ''
				}
			},
			computed: {
				songs() {
					return Object.entries(this.db).map(([id, data]) => ({ id, ...data }));
				},
				hierarchicalTags() {
					const tree = {};
					this.songs.forEach(s => {
						const all = [...(s.song_labels || []), ...s.annotations.map(a => a.label)];
						all.forEach(t => {
							const cat = t.includes('.') ? t.split('.')[0] : 'general';
							if (!tree[cat]) tree[cat] = new Set();
							tree[cat].add(t);
						});
					});
					Object.keys(tree).forEach(k => tree[k] = Array.from(tree[k]).sort());
					return tree;
				},
				totalTagCounts() {
					const counts = {};
					this.songs.forEach(s => {
						const tags = new Set([...(s.song_labels || []), ...s.annotations.map(a => a.label)]);
						tags.forEach(t => counts[t] = (counts[t] || 0) + 1);
					});
					return counts;
				},
				filteredSongs() {
					return this.songs.filter(s => {
						const matchSearch = s.id.toLowerCase().includes(this.searchQuery.toLowerCase());
						const songTags = [...(s.song_labels || []), ...s.annotations.map(a => a.label)];
						const matchSpecific = this.selectedTags.every(t => songTags.includes(t));
						const matchParents = this.selectedCategories.every(cat => 
							songTags.some(t => (t.includes('.') ? t.split('.')[0] : 'general') === cat)
						);
						return matchSearch && matchSpecific && matchParents;
					});
				},
				filteredLyrics() {
					const res = [];
					this.filteredSongs.forEach(s => {
						s.annotations.forEach(a => {
							const tag = a.label;
							const cat = tag.includes('.') ? tag.split('.')[0] : 'general';
							const isTagMatch = this.selectedTags.includes(tag);
							const isCatMatch = this.selectedCategories.includes(cat);
							const noFilter = this.selectedTags.length === 0 && this.selectedCategories.length === 0;
							if (noFilter || isTagMatch || isCatMatch) {
								res.push({ song: s.id, tag: tag, text: a.text });
							}
						});
					});
					return res;
				}
			},
			methods: {
				toggleTag(t) {
					const i = this.selectedTags.indexOf(t);
					if (i > -1) this.selectedTags.splice(i, 1);
					else this.selectedTags.push(t);
				},
				toggleParent(cat) {
					const i = this.selectedCategories.indexOf(cat);
					if (i > -1) this.selectedCategories.splice(i, 1);
					else this.selectedCategories.push(cat);
				},
				resetFilters() {
					this.selectedTags = [];
					this.selectedCategories = [];
				},
				getTagCount(tag) {
					return this.filteredSongs.filter(s => {
						const tags = [...(s.song_labels || []), ...s.annotations.map(a => a.label)];
						return tags.includes(tag);
					}).length;
				},
				async openSong(song) {
					this.currentSong = song;
					this.view = 'song_detail';
					this.rawLyrics = '';
					const fullPath = `lyrics/${song.lyrics_path}`;
					try {
						const r = await fetch(fullPath);
						this.rawLyrics = await r.text();
					} catch (e) { this.rawLyrics = "Lyric file not found."; }
				},
				openSongByTitle(title) {
					const song = this.songs.find(s => s.id === title);
					if (song) this.openSong(song);
				}
			},
			async mounted() {
				try {
					const r = await fetch('songs.json');
					this.db = await r.json();
					this.loading = false;
				} catch (e) { console.error("Error loading JSON", e); }
			}
		}).mount('#app');
	</script>
</body>
</html>